# File Contracts: Claude Code Memory Features Enhancement

**Feature ID**: 001
**Date**: 2025-12-15

---

## Overview

This feature involves file structure contracts only. No API endpoints or database operations are required.

---

## Contract 1: Rule File Format

### Path Pattern
```
.claude/rules/{topic}.md
```

Where `{topic}` is one of:
- `governance`
- `git-workflow`
- `deployment`
- `scope`
- `commands`
- `context-loading`

### Content Contract

```markdown
# {Topic Title}

<!-- Brief description of what this rule file covers -->

## Section 1
{content}

## Section 2
{content}

---
<!-- Optional: Additional context or references -->
```

### Validation Contract

| Rule | Validation |
|------|------------|
| Format | Valid CommonMark markdown |
| Extension | `.md` |
| Location | `.claude/rules/` directory |
| Naming | kebab-case |
| Content | Non-empty |

---

## Contract 2: @-reference Syntax

### Valid Patterns

```
# Relative path (preferred)
@.claude/rules/governance.md

# Nested relative path
@.claude/rules/sub/file.md

# Absolute path (avoid)
@/absolute/path/to/file.md

# Home directory
@~/.claude/custom-rules.md
```

### Invalid Patterns

```
# Inside code block (not evaluated)
```markdown
@.claude/rules/governance.md  # This is NOT imported
```

# Inside inline code (not evaluated)
Reference: `@.claude/rules/governance.md`  # This is NOT imported

# Broken/missing file
@.claude/rules/nonexistent.md  # Error: file not found
```

### Nesting Contract

```
Maximum depth: 5 hops

Example (valid):
CLAUDE.md
  → @.claude/rules/governance.md (hop 1)
    → @.claude/rules/sub/details.md (hop 2)
      → @.claude/rules/sub/more.md (hop 3)  ✓ OK

Example (invalid):
CLAUDE.md
  → @A.md → @B.md → @C.md → @D.md → @E.md → @F.md  ✗ Exceeds 5 hops
```

---

## Contract 3: CLAUDE.md Structure

### Required Sections

```markdown
# CLAUDE.md - {{PROJECT_NAME}}

<!-- Generated by Product-Led Spec-Kit -->

## Core Constraints
<!-- Summary + @-reference to governance.md -->

## Git Workflow
<!-- Summary + @-reference to git-workflow.md -->

## Project Structure
<!-- Keep inline - essential orientation -->

## Scope Boundaries
<!-- Summary + @-reference to scope.md -->

## Commands
<!-- Summary + @-reference to commands.md -->

## Context Loading (READ AS NEEDED)
<!-- Summary + @-reference to context-loading.md -->

## Governance Workflow (MANDATORY)
<!-- Summary + @-reference to governance.md -->

## Deployment Policy (MANDATORY)
<!-- Summary + @-reference to deployment.md -->

## Key Principles
<!-- Keep inline - quick reference -->

## Tips
<!-- Project-specific, inline -->

## Tech Stack
<!-- Project-specific, inline -->

## Recent Changes
<!-- Project-specific, inline -->

## Active Technologies
<!-- Project-specific, inline -->
```

### Size Contract

| Metric | Before | After | Contract |
|--------|--------|-------|----------|
| Line count | 192 | ≤80 | MUST be ≤80 lines |
| Sections | All inline | Mixed | High-level inline + @-references |
| Content | 100% | 100% | No information loss |

---

## Contract 4: Migration Validation

### Input Contract (Before)

```
./CLAUDE.md
├── 192 lines
├── All content inline
└── Manual cat commands for context loading
```

### Output Contract (After)

```
./CLAUDE.md
├── ≤80 lines
├── @-references to rule files
└── Instant context loading via @-syntax

.claude/rules/
├── governance.md      (~50 lines)
├── git-workflow.md    (~20 lines)
├── deployment.md      (~20 lines)
├── scope.md           (~15 lines)
├── commands.md        (~35 lines)
└── context-loading.md (~30 lines)
```

### Validation Contract

```bash
# 1. All rule files exist
for f in governance git-workflow deployment scope commands context-loading; do
  [ -f ".claude/rules/$f.md" ] || echo "FAIL: Missing $f.md"
done

# 2. CLAUDE.md line count
[ $(wc -l < CLAUDE.md) -le 80 ] || echo "FAIL: CLAUDE.md exceeds 80 lines"

# 3. All @-references resolve
grep -o '@\.claude/rules/[a-z-]*\.md' CLAUDE.md | while read ref; do
  file="${ref#@}"
  [ -f "$file" ] || echo "FAIL: Unresolved reference $ref"
done

# 4. Content preservation (manual verification)
# Compare total lines: Original CLAUDE.md ≈ New CLAUDE.md + All rule files
```

---

## Contract 5: Error Handling

### File Not Found

**Trigger**: `@.claude/rules/missing.md` where file doesn't exist

**Expected Behavior**: Claude Code should report file not found

**Recovery Path**:
1. Check file path spelling
2. Verify file exists in .claude/rules/
3. Create missing file if intended

### Circular Reference

**Trigger**:
- governance.md contains `@.claude/rules/commands.md`
- commands.md contains `@.claude/rules/governance.md`

**Expected Behavior**: Claude Code should detect and halt

**Recovery Path**:
1. Identify circular dependency
2. Remove one direction of the reference
3. Restructure content to avoid circularity

### Nesting Depth Exceeded

**Trigger**: More than 5 levels of @-references

**Expected Behavior**: Imports stop at depth 5

**Recovery Path**:
1. Flatten import hierarchy
2. Consolidate deeply nested content
3. Keep depth ≤3 for maintainability

---

## Contract 6: Backward Compatibility

### Old Pattern (Continues to Work)

```markdown
# CLAUDE.md

## Context Loading (READ AS NEEDED)

### By Domain
| Domain | Read This | When Needed |
|--------|-----------|-------------|
| **Triad Workflow** | `docs/core_principles/TRIAD_COLLABORATION.md` | Creating specs |

### Load with cat command
```bash
cat docs/core_principles/TRIAD_COLLABORATION.md
```
```

### New Pattern (Recommended)

```markdown
# CLAUDE.md

## Context Loading
@.claude/rules/context-loading.md
```

### Coexistence Contract

| Scenario | Behavior |
|----------|----------|
| Old CLAUDE.md only | Works unchanged |
| New CLAUDE.md with @-references | Works with instant loading |
| Mixed (both patterns) | Both work, @-references load first |

---

**End of File Contracts**
